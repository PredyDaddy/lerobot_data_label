# 静止帧检测功能迁移与合并超详细方案

## 📋 任务概述
在新分支中将main分支的静止帧检测功能完整迁移到可视化平台，并与duxinyu分支的静止帧删除功能合并，保留main分支的简化检测方法，提供统一的Web界面。

## 🗂️ Duxinyu分支静止帧删除详细机制分析

### 删除操作的5层数据结构
**1. Parquet数据文件删除 (.parquet)**
```python
# 删除操作内容：
- 删除指定timestamp对应的数据行
- 重新计算frame_index保持连续性 (0,1,2,3...)
- 重新计算index保持episode内连续性
- 影响字段：timestamp, action, observation.state, frame_index, episode_index, index, task_index
```

**2. 视频文件帧删除 (.mp4)**
```python
# FFmpeg删除命令：
ffmpeg -i input.mp4 -vf "select='not(eq(n,{frame_index}))',setpts=N/FRAME_RATE/TB"
       -r {fps} -c:v libx264 -crf 23 -preset fast output.mp4

# 删除内容：
- 删除视频中第frame_index帧的图像数据
- 保持固定帧率输出
- 重新编码视频文件
- 支持多视角：laptop、phone等所有video_key
```

**3. Episode元数据更新 (episodes.jsonl)**
```python
# 更新内容：
- 减少episode的length值 (原length - removed_count)
- 保持其他字段不变：task, conditions, created_at等
- 影响数据集的episode统计信息
```

**4. 统计数据重新计算 (episodes_stats.jsonl)**
```python
# 重新计算内容：
- 重新统计observation和action的min/max/mean值
- 保持原始字段顺序和数据结构
- 基于新的数据长度重新计算统计指标
```

**5. 全局信息更新 (info.json)**
```python
# 更新内容：
- 减少total_frames总帧数
- 保持其他配置：fps, features, video_keys等
- 影响数据集的全局统计
```

### 删除策略详细实现

**1. ALL_STATIC（全删除策略）**
```python
# 实现逻辑：
timestamps_to_delete = [r.timestamp for r in results if r.is_static and r.timestamp is not None]

# 删除内容：
- 删除所有motion_score < threshold的帧
- 最激进的压缩，可能删除50%+的数据
- 适用场景：大量明显静止片段的清理
```

**2. SEGMENT_SAMPLE（段采样策略）推荐**
```python
# 实现逻辑：
segments = analyzer.find_static_segments(results)  # 找连续静止片段
for start_frame, end_frame in segments:
    if end_frame - start_frame > 4:  # 片段长度>4才处理
        # 保留首尾2帧，删除中间帧
        for frame_idx in range(start_frame + 2, end_frame - 1):
            timestamps_to_delete.append(result.timestamp)

# 删除内容：
- 识别连续静止片段（如100-150帧都是静止的）
- 保留每段的第100,101和149,150帧
- 删除中间的102-148帧
- 保持时序连续性和关键转折点
```

**3. SMART_PRUNE（智能删除策略）**
```python
# 实现逻辑：
static_results = [r for r in results if r.is_static]
static_results.sort(key=lambda x: x.motion_score)  # 按运动分数排序
delete_count = min(len(static_results) // 2, max_deletions)
timestamps_to_delete = [r.timestamp for r in static_results[:delete_count]]

# 删除内容：
- 基于motion_score分布分析
- 删除运动分数最低的50%静止帧
- 数据驱动的精确删除
```

### 备份机制
```python
# 备份内容：
1. 完整的parquet文件副本 -> backup/{backup_id}/data/
2. 所有相关视频文件副本 -> backup/{backup_id}/videos/
3. episodes.jsonl副本 -> backup/{backup_id}/meta/
4. episodes_stats.jsonl副本 -> backup/{backup_id}/meta/
5. info.json副本 -> backup/{backup_id}/meta/

# 备份恢复：
- 可通过backup_id完整恢复到删除前状态
- 支持部分恢复和增量恢复
```

## 🏛️ 合并后完整代码架构

### 分支策略
```bash
# 新建feature分支进行合并
git checkout -b feature/static-frame-integration main
```

### 架构层次图
```
┌─────────────────────────────────────────────────────────┐
│              Web可视化界面 (新增完整功能面板)                │
│  • 静止帧检测控制   • 删除策略选择   • 进度显示              │
│  • 备份管理界面     • 批量操作      • 结果可视化             │
└─────────────────┬───────────────────────────────────────┘
                  │ HTTP REST API (5个新端点)
┌─────────────────▼───────────────────────────────────────┐
│               Flask Web API层 (app.py)                 │
│  GET  /api/episodes/<id>/static_frames/<video_key>      │
│  GET  /api/episodes/<id>/static_segments/<video_key>    │
│  GET  /api/episodes/<id>/motion_stats/<video_key>       │
│  POST /api/episodes/<id>/static_prune/plan              │
│  POST /api/episodes/<id>/static_prune/execute           │
└─────────────────┬───────────────────────────────────────┘
                  │ 业务逻辑调用
┌─────────────────▼───────────────────────────────────────┐
│            StaticFramePruner (新增业务编排层)            │
│  • 检测计划生成     • 三种删除策略     • 批量操作编排        │
│  • 进度跟踪管理     • 错误恢复机制     • 统计信息收集        │
└─────┬───────────────────────────────────────────┬─────┘
      │ 算法调用                                    │ 删除执行
┌─────▼─────────────────┐                 ┌─────▼─────────────────┐
│   MotionDetector      │                 │   FrameExtractor      │
│  (保留Main分支简化版)   │                 │  (duxinyu完整版)       │
│  • 仅帧差法算法        │                 │  • 5层数据删除        │
│  • 优化配置参数        │                 │  • 备份恢复机制        │
│  • 高性能检测          │                 │  • FFmpeg视频处理     │
└───────────────────────┘                 └───────────────────────┘
```

### 核心文件变更清单

**新增文件：**
```
core/static_pruner.py          # 从duxinyu分支完整迁移
core/frame_extractor.py        # 从duxinyu分支完整迁移
templates/frame_extract_panel.html  # 抽帧面板组件
```

**修改文件：**
```
web/app.py                    # 添加5个新API端点 + StaticPruner初始化
templates/visualize_dataset_template.html  # 集成静止帧检测UI面板
core/motion_detector.py       # 保持main分支版本不变
config.yaml                   # 确保motion_detection配置节存在
```

## 🚀 超详细实施步骤

### 阶段0: 分支创建与准备（10分钟）
**0.1 创建feature分支**
```bash
git checkout main
git pull origin main
git checkout -b feature/static-frame-integration
```

**0.2 确认起始状态**
```bash
git status  # 确认工作区干净
git log --oneline -5  # 确认基于最新main分支
```

### 阶段1: 核心组件迁移（45分钟）

**1.1 迁移StaticFramePruner（15分钟）**
```bash
# 从duxinyu分支提取文件
git show origin/duxinyu:core/static_pruner.py > core/static_pruner.py
```
- 验证import依赖（MotionDetectionConfig, FrameExtractor）
- 确认三种删除策略实现完整
- 测试类初始化和配置加载

**1.2 迁移FrameExtractor（20分钟）**
```bash
# 从duxinyu分支提取文件
git show origin/duxinyu:core/frame_extractor.py > core/frame_extractor.py
```
- 验证5层数据删除逻辑
- 确认FFmpeg视频处理命令
- 测试备份创建和恢复机制
- 验证LeRobot数据集结构兼容性

**1.3 依赖和配置检查（10分钟）**
- 检查requirements.txt是否包含必要依赖
- 确认config.yaml有motion_detection配置节
- 验证两个新模块可以正常导入

### 阶段2: Web API端点开发（50分钟）

**2.1 Flask应用初始化更新（10分钟）**
```python
# 在web/app.py的create_app函数中添加
static_pruner = StaticFramePruner(dataset_path, app_config.config)
```

**2.2 实现5个API端点（30分钟）**

**检测类API（15分钟）:**
```python
@app.route("/api/episodes/<int:episode_id>/static_frames/<video_key>", methods=["GET"])
def api_episode_static_frames(episode_id, video_key):
    # 返回帧级检测结果：frame_index, is_static, motion_score, timestamp

@app.route("/api/episodes/<int:episode_id>/static_segments/<video_key>", methods=["GET"])
def api_episode_static_segments(episode_id, video_key):
    # 返回连续静止片段：start_frame, end_frame, duration_frames

@app.route("/api/episodes/<int:episode_id>/motion_stats/<video_key>", methods=["GET"])
def api_episode_motion_stats(episode_id, video_key):
    # 返回运动统计：total_frames, static_frames, static_ratio, avg_motion_score
```

**操作类API（15分钟）:**
```python
@app.route("/api/episodes/<int:episode_id>/static_prune/plan", methods=["POST"])
def api_static_prune_plan(episode_id):
    # 接收：video_key, policy, max_deletions
    # 返回：PruningPlan对象

@app.route("/api/episodes/<int:episode_id>/static_prune/execute", methods=["POST"])
def api_static_prune_execute(episode_id):
    # 接收：video_key, policy, max_deletions, dry_run, create_backup
    # 返回：PruningResult对象
```

**2.3 统一错误处理和响应格式（10分钟）**
- 标准化JSON错误响应
- 添加请求参数验证
- 实现操作日志记录

### 阶段3: 前端UI面板集成（40分钟）

**3.1 静止帧检测面板组件（20分钟）**
```javascript
// Alpine.js组件：staticFrameDetection()
{
    // 状态管理
    staticDetectionExpanded: true,
    staticDetectionLoading: false,
    selectedVideoKey: '',
    detectionThreshold: 0.02,
    pruningPolicy: 'segment_sample',

    // 数据存储
    staticDetectionResults: null,
    staticSegments: null,
    pruningPlan: null,
    pruningResult: null,

    // 方法实现
    async detectStaticFrames() { /*检测逻辑*/ },
    async generatePruningPlan() { /*计划生成*/ },
    async executePruningPlan() { /*执行删除*/ }
}
```

**3.2 UI面板HTML结构（15分钟）**
```html
<!-- 检测控制区 -->
<div class="detection-controls">
    <select x-model="selectedVideoKey">视频选择</select>
    <select x-model="pruningPolicy">策略选择</select>
    <input x-model="detectionThreshold">阈值调整</input>
</div>

<!-- 操作按钮区 -->
<div class="action-buttons">
    <button @click="detectStaticFrames()">检测静止帧</button>
    <button @click="generatePruningPlan()">生成删除计划</button>
    <button @click="executePruningPlan()">执行删除</button>
</div>

<!-- 结果显示区 -->
<div class="results-display">
    <div class="detection-stats">统计信息显示</div>
    <div class="pruning-plan">删除计划显示</div>
    <div class="execution-result">执行结果显示</div>
</div>
```

**3.3 样式和交互优化（5分钟）**
- 保持与现有界面风格一致
- 添加加载状态和进度指示
- 实现响应式设计

### 阶段4: 功能集成测试（30分钟）

**4.1 单元功能测试（15分钟）**
- 测试静止帧检测API返回正确数据
- 验证三种删除策略生成不同计划
- 测试试运行模式和实际执行模式
- 验证备份创建和数据恢复

**4.2 端到端集成测试（10分钟）**
- 完整用户操作流程测试
- 前后端API通信验证
- 错误场景处理测试
- 界面交互响应测试

**4.3 数据完整性验证（5分钟）**
- 验证删除后数据集结构完整
- 确认索引重新计算正确
- 测试元数据更新准确性

### 阶段5: 文档和清理（15分钟）

**5.1 功能文档更新（5分钟）**
- 更新CLAUDE.md项目说明
- 添加新功能使用说明
- 记录API端点文档

**5.2 代码清理（5分钟）**
- 删除调试脚本和临时文件
- 确保代码格式一致
- 移除无用的注释和代码

**5.3 Git提交（5分钟）**
```bash
git add .
git commit -m "feat: 集成静止帧检测与删除功能到可视化平台

- 从duxinyu分支迁移StaticFramePruner和FrameExtractor
- 保留main分支简化的MotionDetector实现
- 添加5个新的REST API端点支持检测和删除操作
- 集成完整的前端UI面板到可视化界面
- 支持三种删除策略：全删除/段采样/智能删除
- 实现5层数据删除：parquet/视频/元数据/统计/全局信息
- 完整的备份恢复机制确保数据安全

🤖 Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>"
```

## ⚠️ 关键风险点与对策

**1. 数据安全风险**
- 风险：删除操作可能造成数据丢失
- 对策：强制备份机制 + 试运行模式 + 用户确认

**2. 性能影响风险**
- 风险：大量删除操作影响系统性能
- 对策：批量处理优化 + 进度显示 + 后台处理

**3. 兼容性风险**
- 风险：新功能与现有系统冲突
- 对策：独立分支开发 + 渐进式集成 + 回滚机制

**4. 用户误操作风险**
- 风险：用户意外删除重要数据
- 对策：多重确认 + 限制删除数量 + 清晰的操作提示

## 🎯 预期完整功能

### 用户可实现的操作流程
```
1. 选择Episode和视频类型 (laptop/phone)
     ↓
2. 点击"检测静止帧"获得分析结果
     ↓
3. 查看检测统计：总帧数、静止帧数、静止比例
     ↓
4. 选择删除策略 (段采样/全删除/智能删除)
     ↓
5. 点击"生成删除计划"预览删除效果
     ↓
6. 查看计划详情：删除帧数、压缩比、预估节省时间
     ↓
7. 选择执行选项：试运行/创建备份/最大删除数
     ↓
8. 点击"执行删除"完成数据清理
     ↓
9. 查看执行结果：删除成功数、备份ID、处理时间
```

### 技术成果
- **统一的静止帧处理平台**：集检测、分析、删除于一体
- **高性能检测算法**：保留main分支优化的帧差法
- **灵活的删除策略**：三种策略适应不同需求
- **完善的数据安全**：5层备份 + 恢复机制
- **友好的用户界面**：可视化操作 + 实时反馈

## ⏱️ 时间规划总计
**总计约3小时**
- 分支准备：10分钟
- 组件迁移：45分钟
- API开发：50分钟
- 前端集成：40分钟
- 测试验证：30分钟
- 文档清理：15分钟

该方案通过新分支的方式安全地实现了功能合并，确保main分支的稳定性，同时提供了完整的静止帧检测与删除功能。

## 📝 执行检查清单

### 阶段0检查项
- [ ] 确认工作区状态干净
- [ ] 成功创建feature分支
- [ ] 基于最新main分支

### 阶段1检查项
- [ ] StaticFramePruner文件成功迁移
- [ ] FrameExtractor文件成功迁移
- [ ] 所有import依赖验证通过
- [ ] 配置文件motion_detection节确认存在

### 阶段2检查项
- [ ] Flask app初始化StaticPruner成功
- [ ] 5个API端点代码实现完成
- [ ] 错误处理和响应格式统一
- [ ] API路由冲突检查通过

### 阶段3检查项
- [ ] Alpine.js组件代码完成
- [ ] UI面板HTML集成完成
- [ ] 样式与现有界面风格一致
- [ ] 前端交互逻辑验证通过

### 阶段4检查项
- [ ] 静止帧检测功能测试通过
- [ ] 三种删除策略验证通过
- [ ] 试运行和实际执行测试通过
- [ ] 端到端功能流程测试通过

### 阶段5检查项
- [ ] 文档更新完成
- [ ] 临时文件清理完成
- [ ] Git提交信息规范
- [ ] 工作区最终状态整洁